# 前端页面性能指标

### 基础性能指标：

在互联网发展初期，评价前端页面加载性能通常有两个指标FP和FCP。但是随着SPA等现代前端应用的发展，页面很多时候虽然触发了FCP，但是并不是用户所关注的内容，对用户而言，和白屏没有太大区别。

谷歌公司一直十分重视网站的用户体验，移动友好性，页面加载速度和HTTPS是Google已经使用的页面排名因素，而2020年，谷歌将Core Web Vitals新纳入的用户体验指标。其中核心的3个就是LCP、FID、CLS。

**FP**：

表示渲染出第一个像素点，注意，必须是有效的像素点，而不是任意一个dom都有效的，比如下边这个例子

```
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>no FP</title>
  </head>
  <body>
    <div></div>
  </body>
</html>
```
没有有效的像素点，就不会触发FP。

在实际开发中我们通常认为浏览器开始渲染 ```<body>``` 标签或者解析完 ```<head>``` 标签的时刻就是页面白屏结束的时间点。可以在```<body>```标签开始的地方获取时间戳。

起始时间点是用户输入url点击回车后的时间点，可以用```new PerformanceResourceTiming().fetchStart```获取

**FCP**:
表示渲染出第一个内容，这里的“内容”可以是文本、图片、canvas。注意，dom必须是有内容的，如果渲染出的dom只有样式没有内容，那么不会触发FCP，比如下边这个例子:

```
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>has FP, no FCP</title>
    <style>
        div {
            width: 1px;
            height: 1px;
            background-color: red;
        }
    </style>
</head>
<body>
    <div></div>
</body>
</html>
```

可以触发FP，但是不会触发FCP

由于浏览器不一定等到所有DOM都解析完才开始渲染，也就是说在DOM节点很多的情况下，浏览器解析一部分DOM后就会开始渲染，这个时候FP就会先于DCL触发。

**LCP**：最大内容渲染时间，详细见[什么是LCP](./什么是LCP.md)

**CLS**：是对在页面的整个生命周期中发生的每一次意外布局变化的最大布局变化得分的度量，布局变化得分越小证明你的页面越稳定。用户在操作网页或者阅读网页内容的时候，对于网页的稳定性是很敏感的，假设两个用户场景：

1. 用户在很用心的阅读网页内容，但是因为js代码或者请求数据（非用户主动操作）导致页面布局发生了改变，打乱了用户阅读顺序，是非常影响用户体验的
2. 用户在准备点击某个按钮的时候，突然页面布局发生变化导致按钮位置发生变动，用户很有可能发生错误的点击，这也非常影响用户体验


### 交互指标：

**背景知识**：

- 长任务：大于50ms的任务
- 安静窗口：没有长任务且不超过两个正在处理的网络 GET 请求。

**TTI**:

在FCP后，找到第一个长度为5S的安静窗口，TTI就是安静窗口之前最后一个长任务结束的时间，如果没有长任务也没有多余两个的GET请求，那么TTI与FCP的值相同，图解如下：

<div align="center">
    <img src=./前端页面性能指标1.png width=80% />
</div>

上图中黄色虚线位置就是TTI的值，实际项目中，应当尽可能减小TTI与FCP的差距。

**TBT**:

TBT 是 TTI 的一个出色的配套指标，TBT指标中认为，长任务超出50ms的部分是发生了阻塞，统计TTI之前所有长任务的阻塞时长的累积，图解如下：

<div align="center">
    <img src=./前端页面性能指标2.png width=80% />
</div>
<div align="center">
    <img src=./前端页面性能指标3.png width=80% />
</div>

上方的时间轴上有五个任务，其中三个是长任务，因为这些任务的持续时间超过 50 毫秒。虽然在主线程上运行任务的总时间为 560 毫秒，但其中只有 345 毫秒被视为阻塞时间。这个阻塞时间就是TBT

分布在 10 秒钟里的三个 51 毫秒长的任务与单个 10 秒长的任务对 TTI 的影响是相同的，但对于试图与页面进行交互的用户来说，这两种情况给人的感觉是截然不同的。在第一种情况下，三个 51 毫秒的任务的 TBT 为3 毫秒。而单个 10 秒长的任务的 TBT 为9950 毫秒。第二种情况下较大的 TBT 值对较差的体验进行了量化。

**FID**：

FID在FCP之后，在TTI之前，这个阶段页面上已经渲染了部分内容但又没有准备好可靠的交互。如果在这个时间段里用户尝试与页面进行交互，那么交互事件可能会有比较长的延迟影响用户体验。

FID只关注input事件与和离散行为如：点击、触摸、按键事件。当浏览器正在进行其他任务时候，突然触发了input事件，那么事件就需要等它完成后才能响应input事件，这个等待的时长即为FID值。图解如下：

<div align="center">
    <img src=./前端页面性能指标4.png width=80% />
</div>

上图可以看到在浏览器主线程繁忙时候，触发了input事件，那从这个时间点，一直到浏览器主线程空闲这段时间，就是FID