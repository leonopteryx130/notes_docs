# 浏览器的渲染层和合成层

### 渲染层定义

渲染层（Render Layer）是浏览器渲染流程中的一个中间概念，可以把它想象成一张透明的“画布”或“玻璃板”。浏览器会将页面中的不同元素（或元素的某些部分）放置在不同的“画布”上。最终，浏览器会将这些画布按照正确的顺序叠加、合并，最终合成出我们看到的完整页面。

### 为什么需要渲染层

1. **提高渲染效率**：如果页面中的某个小元素（比如一个动画按钮）发生了变化，浏览器理想情况下不应该重新绘制整个页面。如果这个元素在一个独立的渲染层上，浏览器只需要单独重新绘制这一层，然后与其他未变化的层进行合并即可。这大大减少了工作量。目的有点类似于React中的虚拟DOM，通过diff算法只更新变化的部分。

2. **分层可以便于实现硬件加速**：浏览器可以将某些特定的渲染层提升为 **合成层** ，并且可以由GPU（显卡）来直接处理。

### 合成层定义

合成层（Compositing Layer）是渲染层的一个子集，它表示浏览器认为可以独立于其他层进行合成和渲染的部分。合成层通常包含一些具有复杂动画效果或需要频繁重绘的元素。浏览器会将这些合成层单独处理，从而提高渲染效率。

### 哪些元素会形成渲染层

- 文档根元素（html标签）。
- 有明确的CSS定位属性（```position: absolute, relative, fixed, sticky```）并且有一个z-index值。
- 是透明度（opacity小于1）、变换（transform不为none）、滤镜（filter）等效果的元素。
- 是CSS蒙版、剪切（clip-path）的元素。
- 是```canvas```、```video```、```iframe```元素。

### 哪些元素会形成合成层

- 3D 或透视变换的CSS属性（如 ```transform: translateZ(0), transform: 3d(...)```）。translateZ(0) 是一个常用的触发硬件加速的手段
- 使用加速视频解码的 ```video``` 元素。
- 拥有 3D (WebGL) 上下文或加速 2D 上下文的 ```canvas``` 元素。
- 对 opacity, transform, filter, backdrop-filter 应用了CSS过渡或动画。
- 有```will-change```属性，即便你没有立即改变它。这是现代标准中提示浏览器进行优化的推荐方式。
- 有一个z-index较低且有一个z-index较高的兄弟元素（层叠上下文导致它需要被单独提升，以防止被兄弟元素遮盖）。

### 浏览器硬件加速

当浏览器将一个渲染层提升为合成层时，该层会被发送到GPU进行渲染。GPU具有并行处理能力，可以同时处理多个合成层，从而提高渲染效率。此外，硬件加速还可以减少CPU的负担，因为GPU可以处理大部分渲染任务。