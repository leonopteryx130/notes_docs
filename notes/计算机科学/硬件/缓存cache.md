# 缓存cache

**背景知识**：cpu的速度非常快，但是没有存储功能，常用存储设备的速度远远跟不上，高速的存储设备又需要牺牲存储空间，所以就产生了缓存（cache）设备，为了弥合CPU与存储设备之间的速度差距

<div align="center">
    <img src=./缓存cache.png width=80% />
</div>

现在的CPU中通常有多个等级的缓存，一般来说每个CPU都会有L1缓存和L2缓存，其中L1缓存又分为L1i和L1d，分别用来存储指令和数据。L2缓存是不区分指令和数据的。L3缓存多个核心共用一个，通常也不区分指令和数据。

#### **替换策略**
Cache里存的数据是Memory中的常用数据一个拷贝，Cache比较小，不可以缓存Memory中的所有数据。当Cache存满后，再需要存入一个新的条目时，就需要把一个旧的条目从缓存中拿掉，这个过程称为evict，一个被evict的条目称为victim。缓存管理单元通过一定的算法决定哪些数据有资格留在Cache里，哪些数据需要从Cache里移出去。这个策略称为替换策略（replacement policy)。最简单的替换策略称为LRU(least recently used)，即Cache管理单元记录每个Cache line最近被访问的时间，每次需要evict时，选最近一次访问时间最久远的那一条做为victim。在实际使用中，LRU并不一定是最好的替换策略，在CPU设计的过程中，通常会不段对替换策略进行改进，每一款芯片几乎都使用了不同的替换策略。

### **L1缓存与L2缓存的速度差异**

1. 存储容量不同导致的速度差异
L1的容量通常比L2小，容量大的SRAM访问时间就越长，同样制程和设计的情况下，访问延时与容量的开方大致是成正比的。

2. 离CPU远近导致的速度差异
通常L1 Cache离CPU核心需要数据的地方更近，而L2 Cache则处于边缓位置，访问数据时，L2 Cache需要通过更远的铜线，甚至更多的电路，从而增加了延时。
L1 Cache分为ICache（指令缓存）和DCache(数据缓存）,指令缓存ICache通常是放在CPU核心的指令预取单远附近的，数据缓存DCache通常是放在CPU核心的load/store单元附近。而L2 Cache是放在CPU pipeline之外的。

3. 制程不同的造成的速度差异
在实际设计制造时，针对L1/L2的不同角色，L1更加注重速度， L2更加注重节能和容量。